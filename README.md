# Erigon Transaction Replay & Trace Collector

è¿™æ˜¯ä¸€ä¸ªç”¨äºä» Erigon èŠ‚ç‚¹æ”¶é›†ç‰¹å®šæ™ºèƒ½åˆçº¦ï¼ˆå¦‚ Uniswap Routerï¼‰æ“ä½œç è½¨è¿¹ï¼ˆOpcode Tracesï¼‰çš„å·¥å…·ã€‚å®ƒé€šè¿‡é‡æ”¾å†å²åŒºå—ä¸­çš„äº¤æ˜“ï¼Œç»Ÿè®¡ SLOADã€SSTORE ç­‰å…³é”®æŒ‡ä»¤çš„æ‰§è¡Œé¢‘ç‡ï¼Œç”¨äº EVM å­˜å‚¨ä¼˜åŒ–ç ”ç©¶ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **åŒæ¨¡å¼è¿è¡Œ**ï¼šæ”¯æŒå¿«é€Ÿ Shell è„šæœ¬æ¨¡å¼å’Œ Python é«˜çº§å‚æ•°æ¨¡å¼ã€‚
- **å®æ—¶è¿›åº¦æ˜¾ç¤º**ï¼šä½¿ç”¨ `tqdm` æ˜¾ç¤ºåŒé‡è¿›åº¦æ¡ï¼ˆäº¤æ˜“æ”¶é›†è¿›åº¦ + åŒºå—æ‰«æè¿›åº¦ï¼‰ã€‚
- **æ™ºèƒ½æ—¥å¿—ç®¡ç†**ï¼šè¯¦ç»†æ—¥å¿—è‡ªåŠ¨è½¬å­˜è‡³ `logs/`ï¼Œç»ˆç«¯ä»…æ˜¾ç¤ºå…³é”®ä¿¡æ¯ï¼ˆæ”¯æŒ `--verbose` å¼€å¯è¯¦ç»†è¾“å‡ºï¼‰ã€‚
- **ç»“æ„åŒ–è¾“å‡º**ï¼šç»“æœè‡ªåŠ¨ä¿å­˜ä¸º JSON æ ¼å¼è‡³ `results/` ç›®å½•ï¼Œä¾¿äºåç»­åˆ†æã€‚
- **çµæ´»è¾“å…¥**ï¼šæ”¯æŒåè¿›åˆ¶ï¼ˆ`23000000`ï¼‰å’Œåå…­è¿›åˆ¶ï¼ˆ`0x16abb73`ï¼‰åŒºå—å·ã€‚

## ğŸ”§ å®‰è£…ä¸ä¾èµ–

ç¡®ä¿ä½ çš„ç¯å¢ƒä¸­å®‰è£…äº† Python 3ã€‚æ¨èå®‰è£… `tqdm` ä»¥å¯ç”¨è¿›åº¦æ¡åŠŸèƒ½ï¼š

```bash
pip3 install tqdm requests --user
# æˆ–è€…
pip3 install -r requirements.txt --user
```

## ğŸ“– å¿«é€Ÿå¼€å§‹ (Quick Start)

### æ–¹å¼ 1ï¼šä½¿ç”¨å¿«é€Ÿè„šæœ¬ (æ¨è)

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå°è£…å¥½çš„ Shell è„šæœ¬ `quick_replay.sh`ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•ã€‚

```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x quick_replay.sh

# é»˜è®¤è¿è¡Œï¼šæ‰«ææœ€è¿‘ 10,000 ä¸ªåŒºå—ï¼Œæ”¶é›† 500 ç¬”äº¤æ˜“
./quick_replay.sh

# è‡ªå®šä¹‰è¿è¡Œï¼šæ‰«æ 50,000 ä¸ªåŒºå—ï¼Œæ”¶é›† 1,000 ç¬”äº¤æ˜“
./quick_replay.sh 50000 1000
```

### æ–¹å¼ 2ï¼šä½¿ç”¨ Python è„šæœ¬ (é«˜çº§ç”¨æ³•)

ç›´æ¥è¿è¡Œ Python è„šæœ¬å¯ä»¥è·å¾—å®Œå…¨çš„æ§åˆ¶æƒï¼ˆæŒ‡å®š RPC åœ°å€ã€ç²¾ç¡®åŒºå—èŒƒå›´ç­‰ï¼‰ã€‚

**åŸºæœ¬ç”¨æ³•ï¼š**

```bash
python3 router_trace_collector.py \
  --rpc http://127.0.0.1:8545 \
  --start-block 23762019 \
  --end-block 23772019 \
  --output my_experiment.json \
  --max-traces 500
```

**åå°è¿è¡Œæ¨¡å¼ (æ— è¿›åº¦æ¡)ï¼š**

é€‚åˆä½¿ç”¨ `nohup` æŒ‚æœºè¿è¡Œå¤§è§„æ¨¡ä»»åŠ¡ã€‚

```bash
nohup python3 router_trace_collector.py \
  --start-block 23000000 --end-block 23100000 \
  --max-traces 5000 \
  --no-progress &

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/trace.log
```

## âš™ï¸ å‚æ•°è¯´æ˜

| å‚æ•°            | ç¼©å†™ | è¯´æ˜                             | é»˜è®¤å€¼                            |
| --------------- | ---- | -------------------------------- | --------------------------------- |
| `--rpc`         |      | Erigon èŠ‚ç‚¹çš„ RPC åœ°å€           | `http://127.0.0.1:8545`           |
| `--start-block` |      | å¼€å§‹åŒºå—é«˜åº¦ (æ”¯æŒ hex/dec)      | æœ€æ–°åŒºå— - 1000                   |
| `--end-block`   |      | ç»“æŸåŒºå—é«˜åº¦ (æ”¯æŒ hex/dec)      | æœ€æ–°åŒºå—                          |
| `--output`      | `-o` | ç»“æœæ–‡ä»¶å (è‡ªåŠ¨å­˜å…¥ `results/`) | `router_opcodes_{timestamp}.json` |
| `--max-traces`  | `-m` | æ”¶é›†è¾¾åˆ°æ­¤äº¤æ˜“æ•°é‡ååœæ­¢         | 100                               |
| `--verbose`     | `-v` | åœ¨ç»ˆç«¯æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—               | False                             |
| `--no-progress` |      | ç¦ç”¨è¿›åº¦æ¡ (é€‚åˆæ—¥å¿—é‡å®šå‘)      | False                             |

## ğŸ“‚ è¾“å‡ºæ–‡ä»¶ç»“æ„

### 1. ç»“æœæ–‡ä»¶ (`results/*.json`)

ç”Ÿæˆçš„ JSON åŒ…å«å…ƒæ•°æ®ã€å•ç¬”äº¤æ˜“è¯¦æƒ…å’Œèšåˆç»Ÿè®¡ï¼š

```json
{
  "range": {
    "startBlock": 23762019,
    "endBlock": 23772019
  },
  "contracts": {
    "0x881d40237659c251811cec9c364ef91dc08d300c": "Metamask Swap Router"
  },
  "aggregate": {
    "Metamask Swap Router": {
      "SLOAD": 4250,
      "SSTORE": 1391,
      "tx_count": 50
    }
  },
  "transactions": [
    {
      "txHash": "0x...",
      "blockNumber": 23762019,
      "target": "Metamask Swap Router",
      "opcodeCounts": {
        "PUSH1": 757,
        "SLOAD": 64,
        "SSTORE": 21
      }
    }
  ]
}
```

### 2. æ—¥å¿—æ–‡ä»¶ (`logs/trace.log`)

æ‰€æœ‰è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ã€é”™è¯¯å †æ ˆå’Œå•ç¬”äº¤æ˜“æ•è·è®°å½•éƒ½ä¼šä¿å­˜åœ¨è¿™é‡Œã€‚

## ğŸ“Š æ€§èƒ½å‚è€ƒ

åœ¨æœ¬åœ° Erigon èŠ‚ç‚¹ä¸Šçš„å¤§æ¦‚è¿è¡Œé€Ÿåº¦ï¼š

| åŒºå—èŒƒå›´ | æ”¶é›†äº¤æ˜“æ•° | é¢„è®¡è€—æ—¶ | è¾“å‡ºå¤§å° |
| -------- | ---------- | -------- | -------- |
| 100      | ~10        | < 5 ç§’   | 50 KB    |
| 10,000   | 500        | ~25 ç§’   | 1.2 MB   |
| 100,000  | 2000       | 2-3 åˆ†é’Ÿ | 5 MB     |

## ğŸ›  æ•…éšœæ’æŸ¥

**Q: æç¤º "Connection refused" æˆ–æ— æ³•è¿æ¥ RPC**
> æ£€æŸ¥ Erigon æ˜¯å¦å·²åœ¨ç¦»çº¿æ¨¡å¼å¯åŠ¨ï¼Œå¹¶ä¸” `--http` ç«¯å£é…ç½®æ­£ç¡®ã€‚
> ```bash
> # æµ‹è¯•è¿æ¥
> curl -X POST http://127.0.0.1:8545 \
>   -H "Content-Type: application/json" \
>   -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
> ```

**Q: è„šæœ¬æƒé™ä¸è¶³**
> ```bash
> chmod +x quick_replay.sh
> ```

**Q: SSH ç»ˆç«¯é‡Œè¿›åº¦æ¡ä¹±ç **
> å°è¯•æ·»åŠ  `--no-progress` å‚æ•°è¿è¡Œï¼Œæˆ–æ£€æŸ¥ç»ˆç«¯çš„ UTF-8 æ”¯æŒã€‚

## ğŸ’¡ æ•°æ®åˆ†ææŠ€å·§ (jq)

ä½¿ç”¨ `jq` å‘½ä»¤è¡Œå·¥å…·å¿«é€Ÿåˆ†æ `results/` ä¸‹çš„ JSON æ–‡ä»¶ï¼š

**1. ç»Ÿè®¡ç‰¹å®šåˆçº¦çš„äº¤æ˜“æ•°ï¼š**
```bash
cat results/result.json | jq '.transactions[] | select(.target == "1inch Aggregation Router V6")'
```

**2. æ‰¾å‡º SLOAD æ¶ˆè€—æœ€å¤šçš„å‰ 5 ç¬”äº¤æ˜“ï¼š**
```bash
cat results/result.json | jq '.transactions | sort_by(.opcodeCounts.SLOAD) | reverse | .[0:5]'
```